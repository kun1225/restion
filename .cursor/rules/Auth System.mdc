---
description: 
globs: 
alwaysApply: false
---
# Restion JWT Authentication System

## System Architecture

### Token Types

1. **Access Token**

   - çŸ­æœŸæœ‰æ•ˆï¼ˆ15åˆ†é˜ï¼‰
   - ç”¨æ–¼ API è«‹æ±‚èªè­‰
   - åŒ…å«ç”¨æˆ¶åŸºæœ¬ä¿¡æ¯ï¼ˆid, type, jtiï¼‰
   - å­˜å„²åœ¨å‰ç«¯è¨˜æ†¶é«”ä¸­

2. **Refresh Token**
   - é•·æœŸæœ‰æ•ˆï¼ˆ7å¤©ï¼‰
   - ç”¨æ–¼æ›´æ–° access token
   - å­˜å„²åœ¨ HttpOnly Cookie ä¸­
   - æ”¯æ´ token rotation

### Security Features

- âœ… **Token Rotation**: æ¯æ¬¡åˆ·æ–°éƒ½æœƒç”¢ç”Ÿæ–°çš„ refresh token
- âœ… **Token Revocation**: æ”¯æ´æ’¤éŠ·å·²ç™¼å‡ºçš„ tokens
- âœ… **Blacklist æª¢æŸ¥**: æª¢æŸ¥ access token æ˜¯å¦åœ¨é»‘åå–®ä¸­
- âœ… **HttpOnly Cookies**: Refresh token å­˜åœ¨å®‰å…¨ cookie ä¸­
- âœ… **å®šæœŸæ¸…ç†**: è‡ªå‹•æ¸…ç†éæœŸçš„ token è¨˜éŒ„

## Database Architecture

### refresh_tokens table

```sql
CREATE TABLE refresh_tokens (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  token_hash VARCHAR(255) NOT NULL UNIQUE,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  revoked_at TIMESTAMP NULL,
  device_info JSONB
);
```

### revoked_tokens table

```sql
CREATE TABLE revoked_tokens (
  id SERIAL PRIMARY KEY,
  jti VARCHAR(255) NOT NULL UNIQUE,
  user_id INTEGER REFERENCES users(id),
  revoked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP NOT NULL
);
```

## API Endpoints

### Public endpoints (no authentication)

| æ–¹æ³• | ç«¯é»                 | æè¿°              |
| ---- | -------------------- | ----------------- |
| POST | `/api/auth/register` | è¨»å†Šæ–°ç”¨æˆ¶        |
| POST | `/api/auth/login`    | ç”¨æˆ¶ç™»å…¥          |
| POST | `/api/auth/refresh`  | åˆ·æ–° access token |

### Protected endpoints (authentication required)

| æ–¹æ³• | ç«¯é»                   | æè¿°                    |
| ---- | ---------------------- | ----------------------- |
| GET  | `/api/auth/me`         | ç²å–ç•¶å‰ç”¨æˆ¶ä¿¡æ¯        |
| POST | `/api/auth/logout`     | ç™»å‡ºï¼ˆæ’¤éŠ·ç•¶å‰ tokensï¼‰ |
| POST | `/api/auth/logout-all` | ç™»å‡ºæ‰€æœ‰è¨­å‚™            |

## Authentication Flow

### 1. Register/Login

```javascript
// frontend request
POST /api/auth/login
{
  "email": "user@example.com",
  "password": "password123"
}

// backend response
{
  "success": true,
  "data": {
    "user": { ... },
    "accessToken": "eyJhbGciOiJIUzI1NiIs..."
  }
}

// set HttpOnly Cookie
Set-Cookie: refresh_token=abc123...; HttpOnly; Secure; SameSite=Strict
```

### 2. Use Access Token

```javascript
// frontend request
GET /api/auth/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

### 3. Refresh Token

```javascript
// frontend request (auto send refresh token cookie)
POST /api/auth/refresh

// backend response
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs..."
  }
}

// set new refresh token cookie
```

### 4. Logout

```javascript
// frontend request
POST /api/auth/logout
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...

// backend action:
// 1. revoke access token (add to blacklist)
// 2. revoke refresh token
// 3. clear cookie
```

## Middleware

### authenticateToken

é©—è­‰ access token çš„ä¸­é–“ä»¶ï¼š

1. æå– Bearer token
2. é©—è­‰ JWT ç°½åå’ŒéæœŸæ™‚é–“
3. æª¢æŸ¥ token æ˜¯å¦åœ¨é»‘åå–®ä¸­
4. é©—è­‰ç”¨æˆ¶æ˜¯å¦å­˜åœ¨
5. å°‡ç”¨æˆ¶ä¿¡æ¯é™„åŠ åˆ° request å°è±¡

```javascript
// usage
router.get('/protected', authenticateToken, handler);
```

## Auto Cleanup

ç³»çµ±æ¯å°æ™‚è‡ªå‹•æ¸…ç†ï¼š

- éæœŸçš„ revoked tokens
- éæœŸçš„ refresh tokens
- è¢«æ’¤éŠ·ä¸”å·²éæœŸçš„ refresh tokens

## Environment Variables

```bash
# JWT secret
ACCESS_TOKEN_SECRET=your_super_secret_access_token_key
REFRESH_TOKEN_SECRET=your_super_secret_refresh_token_key

# frontend URL (CORS)
FRONTEND_URL=http://localhost:3000

# server config
PORT=3001
NODE_ENV=development
```

## Test

é‹è¡ŒåŒ…å«çš„æ¸¬è©¦è…³æœ¬ï¼š

```bash
# å•Ÿå‹•ä¼ºæœå™¨
npm run dev

# åœ¨å¦ä¸€å€‹çµ‚ç«¯é‹è¡Œæ¸¬è©¦
node test-auth.js
```

æ¸¬è©¦è¦†è“‹ï¼š

- ç”¨æˆ¶è¨»å†Š
- ç”¨æˆ¶ç™»å…¥
- ç²å–ç”¨æˆ¶ä¿¡æ¯
- Token æ’¤éŠ·é©—è­‰
- ç™»å‡ºåŠŸèƒ½

## ğŸš¨ éŒ¯èª¤è™•ç†

ç³»çµ±å®šç¾©äº†å®Œæ•´çš„éŒ¯èª¤ä»£ç¢¼ï¼š

- `NO_TOKEN`: ç¼ºå°‘ token
- `TOKEN_EXPIRED`: Token å·²éæœŸ
- `TOKEN_REVOKED`: Token å·²è¢«æ’¤éŠ·
- `INVALID_TOKEN`: ç„¡æ•ˆçš„ token
- `USER_NOT_FOUND`: ç”¨æˆ¶ä¸å­˜åœ¨
- `INVALID_REFRESH_TOKEN`: ç„¡æ•ˆçš„ refresh token
- `INVALID_CREDENTIALS`: ç™»å…¥æ†‘è­‰éŒ¯èª¤

## ğŸ“ˆ ç›£æ§å’Œçµ±è¨ˆ

å¯ä»¥ä½¿ç”¨ `getTokenStats()` å‡½æ•¸ç²å– token çµ±è¨ˆä¿¡æ¯ï¼š

```javascript
import { getTokenStats } from './utils/cleanup';

const stats = await getTokenStats();
console.log(stats);
// {
//   totalRefreshTokens: 150,
//   expiredRefreshTokens: 20,
//   revokedRefreshTokens: 5,
//   totalRevokedAccessTokens: 30,
//   expiredRevokedAccessTokens: 10
// }
```

## Best Practices

1. **å‰ç«¯ Token ç®¡ç†**ï¼š

   - Access token å­˜åœ¨è¨˜æ†¶é«”ä¸­ï¼ˆç‹€æ…‹ç®¡ç†ï¼‰
   - è¨­ç½®è‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶
   - 401 éŒ¯èª¤æ™‚è‡ªå‹•é‡å®šå‘åˆ°ç™»å…¥é 

2. **å®‰å…¨è€ƒæ…®**ï¼š

   - ä½¿ç”¨ HTTPSï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
   - å®šæœŸè¼ªæ› JWT å¯†é‘°
   - ç›£æ§ç•°å¸¸ç™»å…¥æ´»å‹•
   - å¯¦æ–½é€Ÿç‡é™åˆ¶

3. **æ•ˆèƒ½å„ªåŒ–**ï¼š
   - Redis å¿«å–ç”¨æˆ¶ä¿¡æ¯
   - æ‰¹é‡æ¸…ç†éæœŸè¨˜éŒ„
   - è³‡æ–™åº«ç´¢å¼•å„ªåŒ–

## Upgrade and Migration

å¦‚æœå¾èˆŠçš„ JWT ç³»çµ±é·ç§»ï¼š

1. ä¿ç•™èˆŠçš„ `JWT_SECRET` è¨­å®šå‘å¾Œç›¸å®¹
2. é€æ­¥å°‡ç”¨æˆ¶é·ç§»åˆ°æ–°ç³»çµ±
3. ç›£æ§é›™ç³»çµ±é‹è¡Œç‹€æ³
4. æœ€çµ‚ç§»é™¤èˆŠç³»çµ±ä»£ç¢¼
