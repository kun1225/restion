# Restion Backend æ¸¬è©¦ç³»çµ± - å¯¦æ–½ç¸½çµ

## ğŸ¯ å·²å®Œæˆçš„å·¥ä½œ

### 1. æ¸¬è©¦æ¡†æ¶è¨­ç½®

- âœ… å®‰è£ä¸¦é…ç½® Jest æ¸¬è©¦æ¡†æ¶
- âœ… é…ç½® TypeScript æ”¯æ´ (ts-jest)
- âœ… å®‰è£ supertest ç”¨æ–¼ API æ¸¬è©¦
- âœ… è¨­ç½®æ¸¬è©¦ç’°å¢ƒè®Šæ•¸å’Œé…ç½®

### 2. æ¸¬è©¦çµæ§‹å»ºç«‹

```
tests/
â”œâ”€â”€ unit/                   # å–®å…ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ hash.test.ts       âœ… å¯†ç¢¼å“ˆå¸Œå·¥å…·æ¸¬è©¦ (å®Œæˆ)
â”‚   â”œâ”€â”€ jwt.test.ts        ğŸ“ JWT å·¥å…·æ¸¬è©¦ (å·²å»ºç«‹ï¼Œéœ€è¦DB)
â”‚   â”œâ”€â”€ models.test.ts     ğŸ“ è³‡æ–™æ¨¡å‹æ¸¬è©¦ (å·²å»ºç«‹ï¼Œéœ€è¦DB)
â”‚   â”œâ”€â”€ middleware.test.ts ğŸ“ ä¸­é–“ä»¶æ¸¬è©¦ (å·²å»ºç«‹ï¼Œéœ€è¦DB)
â”‚   â””â”€â”€ cleanup.test.ts    ğŸ“ æ¸…ç†å·¥å…·æ¸¬è©¦ (å·²å»ºç«‹ï¼Œéœ€è¦DB)
â”œâ”€â”€ integration/           # æ•´åˆæ¸¬è©¦
â”‚   â””â”€â”€ auth.test.ts       ğŸ“ èªè­‰ API æ¸¬è©¦ (å·²å»ºç«‹ï¼Œéœ€è¦DB)
â”œâ”€â”€ helpers/               # æ¸¬è©¦è¼”åŠ©å·¥å…·
â”‚   â””â”€â”€ testDb.ts          ğŸ“ è³‡æ–™åº«æ¸¬è©¦åŠ©æ‰‹ (å·²å»ºç«‹)
â”œâ”€â”€ setup.ts               âœ… æ¸¬è©¦ç’°å¢ƒè¨­ç½®
â”œâ”€â”€ jest.d.ts              âœ… Jest é¡å‹è²æ˜
â”œâ”€â”€ simple.test.ts         âœ… åŸºæœ¬ç’°å¢ƒæ¸¬è©¦ (æ­£å¸¸é‹è¡Œ)
â””â”€â”€ README.md              âœ… æ¸¬è©¦èªªæ˜æ–‡ä»¶
```

### 3. æ¸¬è©¦è…³æœ¬å’Œå·¥å…·

- âœ… `npm test` - é‹è¡Œæ‰€æœ‰æ¸¬è©¦
- âœ… `npm run test:unit` - åªé‹è¡Œå–®å…ƒæ¸¬è©¦
- âœ… `npm run test:integration` - åªé‹è¡Œæ•´åˆæ¸¬è©¦
- âœ… `npm run test:watch` - ç›£è¦–æ¨¡å¼
- âœ… `npm run test:coverage` - ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
- âœ… `node run-tests.js` - è‡ªå®šç¾©æ¸¬è©¦é‹è¡Œå™¨

### 4. å·²é€šéçš„æ¸¬è©¦

#### âœ… åŸºæœ¬ç’°å¢ƒæ¸¬è©¦ (tests/simple.test.ts)

- åŸºæœ¬ JavaScript åŠŸèƒ½
- ç’°å¢ƒè®Šæ•¸è¨­ç½®
- éåŒæ­¥æ“ä½œ

#### âœ… å¯†ç¢¼å“ˆå¸Œå·¥å…·æ¸¬è©¦ (tests/unit/hash.test.ts)

- å¯†ç¢¼å“ˆå¸ŒåŠŸèƒ½ (hashPassword)
- å¯†ç¢¼æ¯”è¼ƒåŠŸèƒ½ (comparePassword)
- é‚Šç·£æƒ…æ³è™•ç†
- éŒ¯èª¤è™•ç†

**æ¸¬è©¦è¦†è“‹ç‡**: 7/7 æ¸¬è©¦é€šé

## ğŸ”§ é…ç½®è©³æƒ…

### Jest é…ç½® (jest.config.js)

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],
  collectCoverageFrom: ['src/**/*.ts', '!src/**/*.d.ts', '!src/app.ts'],
  coverageDirectory: 'coverage',
  setupFilesAfterEnv: ['<rootDir>/tests/setup.ts'],
  testTimeout: 10000,
};
```

### è³‡æ–™åº«é…ç½®

- âœ… æ¸¬è©¦ç’°å¢ƒé…ç½®å·²æ·»åŠ åˆ° `knexfile.ts`
- âœ… æ¸¬è©¦è³‡æ–™åº«è¨­å®š: `restion_test_db`
- âœ… æœ€å°é€£æ¥æ± é…ç½®ç”¨æ–¼æ¸¬è©¦

### ç’°å¢ƒè®Šæ•¸

```bash
NODE_ENV=test
ACCESS_TOKEN_SECRET=test_access_secret_key_for_testing_only
REFRESH_TOKEN_SECRET=test_refresh_secret_key_for_testing_only
DB_NAME=restion_test_db
```

## ğŸ“Š æ¸¬è©¦ç‹€æ…‹

| æ¸¬è©¦å¥—ä»¶     | ç‹€æ…‹      | é€šéç‡ | èªªæ˜             |
| ------------ | --------- | ------ | ---------------- |
| åŸºæœ¬ç’°å¢ƒæ¸¬è©¦ | âœ… é€šé   | 3/3    | é©—è­‰æ¸¬è©¦ç’°å¢ƒé…ç½® |
| å¯†ç¢¼å“ˆå¸Œæ¸¬è©¦ | âœ… é€šé   | 7/7    | å®Œæ•´æ¸¬è©¦å¯†ç¢¼åŠŸèƒ½ |
| JWT å·¥å…·æ¸¬è©¦ | ğŸ”¶ éœ€è¦DB | 0/15   | éœ€è¦è³‡æ–™åº«é€£æ¥   |
| æ¨¡å‹æ¸¬è©¦     | ğŸ”¶ éœ€è¦DB | 0/8    | éœ€è¦è³‡æ–™åº«é€£æ¥   |
| ä¸­é–“ä»¶æ¸¬è©¦   | ğŸ”¶ éœ€è¦DB | 0/8    | éœ€è¦è³‡æ–™åº«é€£æ¥   |
| æ¸…ç†å·¥å…·æ¸¬è©¦ | ğŸ”¶ éœ€è¦DB | 0/6    | éœ€è¦è³‡æ–™åº«é€£æ¥   |
| æ•´åˆæ¸¬è©¦     | ğŸ”¶ éœ€è¦DB | 0/14   | éœ€è¦è³‡æ–™åº«é€£æ¥   |

**ç¸½è¨ˆ**: 10/61 æ¸¬è©¦æ­£å¸¸é‹è¡Œ (16.4%)

## ğŸš§ å¾…å®Œæˆçš„å·¥ä½œ

### 1. è³‡æ–™åº«è¨­ç½®

ç‚ºäº†é‹è¡Œå®Œæ•´çš„æ¸¬è©¦å¥—ä»¶ï¼Œéœ€è¦ï¼š

```bash
# 1. å‰µå»ºæ¸¬è©¦è³‡æ–™åº«
createdb restion_test_db

# 2. é‹è¡Œè³‡æ–™åº«é·ç§»
NODE_ENV=test npm run migrate

# 3. è¨­ç½®æ­£ç¢ºçš„è³‡æ–™åº«æ†‘è­‰
# åœ¨ .env.test æˆ–ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š
```

### 2. ä¿®å¾©é¡å‹å•é¡Œ

- ä¿®å¾© User æ¨¡å‹ä¸­çš„ `rest_ratio` å’Œ `reminder_interval` å±¬æ€§é¡å‹å®šç¾©

### 3. å®Œå–„æ¸¬è©¦è¦†è“‹ç‡

ä¸€æ—¦è³‡æ–™åº«è¨­ç½®å®Œæˆï¼Œé æœŸæ¸¬è©¦è¦†è“‹ç‡ï¼š

- **ç›®æ¨™**: 80%+ ä»£ç¢¼è¦†è“‹ç‡
- **é‡é»**: JWT åŠŸèƒ½ã€èªè­‰ä¸­é–“ä»¶ã€API ç«¯é»

## ğŸ¯ ç«‹å³å¯ç”¨çš„åŠŸèƒ½

### é‹è¡ŒåŸºæœ¬æ¸¬è©¦

```bash
# é‹è¡Œå¯ç”¨çš„æ¸¬è©¦
node run-tests.js

# æˆ–ç›´æ¥é‹è¡Œç‰¹å®šæ¸¬è©¦
npx jest tests/simple.test.ts
npx jest tests/unit/hash.test.ts
```

### é–‹ç™¼æ™‚ä½¿ç”¨

```bash
# ç›£è¦–æ¨¡å¼ (ç”¨æ–¼é–‹ç™¼)
npm run test:watch

# åªæ¸¬è©¦å¯†ç¢¼åŠŸèƒ½
npx jest tests/unit/hash.test.ts --watch
```

## ğŸŒŸ æ¸¬è©¦ç³»çµ±ç‰¹è‰²

1. **åˆ†å±¤æ¸¬è©¦**: å–®å…ƒæ¸¬è©¦ â†’ æ•´åˆæ¸¬è©¦ â†’ E2Eæ¸¬è©¦
2. **æ¸¬è©¦éš”é›¢**: æ¯å€‹æ¸¬è©¦ä½¿ç”¨ç¨ç«‹çš„è³‡æ–™åº«ç‹€æ…‹
3. **è‡ªå‹•æ¸…ç†**: æ¸¬è©¦å¾Œè‡ªå‹•æ¸…ç†æ¸¬è©¦è³‡æ–™
4. **é¡å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript æ”¯æ´
5. **è¦†è“‹ç‡å ±å‘Š**: è©³ç´°çš„ä»£ç¢¼è¦†è“‹ç‡åˆ†æ
6. **CI/CD å°±ç·’**: å¯ç›´æ¥æ•´åˆåˆ°æŒçºŒæ•´åˆæµç¨‹

## ğŸ“š åƒè€ƒè³‡æ–™

- [æ¸¬è©¦èªªæ˜æ–‡ä»¶](./tests/README.md) - è©³ç´°çš„æ¸¬è©¦æŒ‡å—
- [Jest å®˜æ–¹æ–‡æª”](https://jestjs.io/)
- [Supertest æ–‡æª”](https://github.com/visionmedia/supertest)
- [æ¸¬è©¦æœ€ä½³å¯¦è¸](https://github.com/goldbergyoni/javascript-testing-best-practices)

## ğŸ”œ ä¸‹ä¸€æ­¥

1. **è¨­ç½®æ¸¬è©¦è³‡æ–™åº«**
2. **é‹è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶**
3. **é”åˆ° 80%+ æ¸¬è©¦è¦†è“‹ç‡**
4. **æ•´åˆåˆ° CI/CD æµç¨‹**
5. **æ·»åŠ æ€§èƒ½æ¸¬è©¦**

---

**æœ€å¾Œæ›´æ–°**: 2024å¹´12æœˆ18æ—¥  
**ç³»çµ±ç‹€æ…‹**: åŸºç¤æ¸¬è©¦ç³»çµ±å·²å»ºç«‹ï¼Œç­‰å¾…è³‡æ–™åº«é…ç½®å®Œæˆå…¨åŠŸèƒ½æ¸¬è©¦
